# üîß Fixes to Apply - Reports Feature

## Priority 1: Critical Fixes

### Fix 1: Memory Leak trong useFinancialReport

**File:** `hooks/useFinancialReport.js`

**Changes:**
```javascript
import { useState, useEffect, useRef, useCallback } from "react";

export const useFinancialReport = (propertyId, periodType = "MONTHLY", autoGenerate = true, roomId = null) => {
  // ... existing state
  
  // ‚úÖ Wrap fetchData v·ªõi useCallback
  const fetchData = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);

      const summaryData = await reportService.getFinancialSummary(
        propertyId,
        periodType,
        12,
        roomId
      );

      // ... existing auto-generate logic
      
      setData(summaryData || []);
    } catch (err) {
      console.error("Error fetching financial report:", err);
      setError(err.message);
    } finally {
      setLoading(false);
    }
  }, [propertyId, periodType, autoGenerate, roomId]);

  useEffect(() => {
    fetchData();
  }, [fetchData]); // ‚úÖ Use fetchData in deps

  // ‚úÖ Fix realtime subscription cleanup
  useEffect(() => {
    if (!propertyId && propertyId !== null) return; // Allow null for all properties

    let refetchTimeout;
    let isMounted = true; // ‚úÖ Track mount status

    const debouncedRefetch = () => {
      if (!isMounted) return; // ‚úÖ Check if still mounted
      
      clearTimeout(refetchTimeout);
      refetchTimeout = setTimeout(async () => {
        if (!isMounted) return; // ‚úÖ Double check
        
        try {
          const updatedData = await reportService.getFinancialSummary(
            propertyId,
            periodType,
            12,
            roomId
          );
          if (isMounted) {
            setData(updatedData);
          }
        } catch (error) {
          console.error("Auto-refresh financial report failed:", error);
          if (isMounted) {
            fetchData();
          }
        }
      }, 2000);
    };

    // ... existing subscription code ...

    return () => {
      isMounted = false; // ‚úÖ Mark as unmounted
      clearTimeout(refetchTimeout); // ‚úÖ Clear timeout
      supabase.removeChannel(channel);
    };
  }, [propertyId, periodType, roomId, fetchData]); // ‚úÖ Add fetchData to deps
};
```

---

### Fix 2: Race Condition trong Auto-generate

**File:** `hooks/useFinancialReport.js`

**Changes:**
```javascript
const hasAutoGenerated = useRef(false);
const isGeneratingRef = useRef(false); // ‚úÖ Add generating flag

// In fetchData:
if (propertyId && !roomId && (!summaryData || summaryData.length === 0) && 
    autoGenerate && !hasAutoGenerated.current && !isGeneratingRef.current) {
  
  isGeneratingRef.current = true; // ‚úÖ Set flag
  hasAutoGenerated.current = true;
  
  try {
    // ... generate logic
  } catch (genError) {
    console.error("Auto-generate report failed:", genError);
    hasAutoGenerated.current = false; // ‚úÖ Reset on error
    setData([]);
  } finally {
    isGeneratingRef.current = false; // ‚úÖ Always reset
  }
}
```

---

### Fix 3: Memoize Chart Data

**File:** `components/FinancialReportChart.jsx`

**Changes:**
```javascript
import React, { useState, useMemo } from "react";

const FinancialReportChart = ({ data, loading, error, compact = false }) => {
  // ... existing state

  // ‚úÖ Memoize chart data transformation
  const chartData = useMemo(() => {
    if (!data || data.length === 0) return [];
    
    return data.map((item) => ({
      period: new Date(item.period_start).toLocaleDateString("vi-VN", {
        month: "short",
        year: "numeric",
      }),
      fullPeriod: `${new Date(item.period_start).toLocaleDateString("vi-VN", {
        day: "2-digit",
        month: "2-digit",
      })} - ${new Date(item.period_end).toLocaleDateString("vi-VN", {
        day: "2-digit",
        month: "2-digit",
        year: "numeric",
      })}`,
      totalRevenue: parseFloat(item.total_potential_revenue || 0),
      receivedRevenue: parseFloat(item.total_revenue || 0),
      unpaidAmount: parseFloat(item.unpaid_amount || 0),
      overdueAmount: parseFloat(item.overdue_amount || 0),
      totalUnpaidAmount: parseFloat(item.total_unpaid_amount || 0),
      actualExpenses: parseFloat(item.total_expenses || 0),
      estimatedExpenses: parseFloat(item.estimated_expenses || 0),
      expenses: parseFloat(item.total_expenses || 0),
      profit: parseFloat(item.net_profit || 0),
      collectionRate: parseFloat(item.collection_rate || 0),
    })).reverse(); // ‚úÖ Reverse once
  }, [data]);

  // ‚úÖ Memoize summary calculations
  const latestData = useMemo(() => data?.[0], [data]);
  const previousData = useMemo(() => data?.[1] || latestData, [data, latestData]);

  // ... rest of component
};
```

---

### Fix 4: Improve Loading States

**File:** `pages/reports.jsx`

**Changes:**
```javascript
const renderOverview = () => {
  const latestFinancial = financialReport.data?.[0];
  const latestOccupancy = occupancyReport.data?.[0];
  const latestMaintenance = maintenanceReport.data?.[0];
  
  // ‚úÖ Check loading state
  const isLoading = financialReport.loading || 
                    occupancyReport.loading || 
                    maintenanceReport.loading;
  
  const hasError = financialReport.error || 
                   occupancyReport.error || 
                   maintenanceReport.error;

  if (isLoading) {
    return (
      <div className="space-y-6">
        {/* Skeleton loaders */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          {[1, 2, 3, 4].map((i) => (
            <div key={i} className="bg-gray-200 rounded-xl h-32 animate-pulse" />
          ))}
        </div>
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {[1, 2].map((i) => (
            <div key={i} className="bg-gray-200 rounded-xl h-64 animate-pulse" />
          ))}
        </div>
      </div>
    );
  }

  if (hasError) {
    return (
      <div className="bg-red-50 border border-red-200 rounded-xl p-6 text-center">
        <p className="text-red-600 mb-4">
          ƒê√£ x·∫£y ra l·ªói khi t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i.
        </p>
        <button
          onClick={handleRefresh}
          className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
        >
          Th·ª≠ l·∫°i
        </button>
      </div>
    );
  }

  // ... existing render code
};
```

---

### Fix 5: Better Empty States

**File:** `components/FinancialReportChart.jsx`

**Changes:**
```javascript
if (!data || data.length === 0) {
  return (
    <div className="flex flex-col items-center justify-center h-64 text-gray-500">
      <CurrencyDollarIcon className="h-16 w-16 mb-4 text-gray-300" />
      <p className="text-lg font-medium text-gray-700 mb-2">
        Ch∆∞a c√≥ d·ªØ li·ªáu b√°o c√°o t√†i ch√≠nh
      </p>
      <p className="text-sm text-gray-500 mb-4 text-center max-w-md">
        H√£y t·∫°o b√°o c√°o ho·∫∑c ch·ªçn kho·∫£ng th·ªùi gian kh√°c ƒë·ªÉ xem d·ªØ li·ªáu
      </p>
      {onGenerateReport && (
        <button
          onClick={onGenerateReport}
          className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
        >
          T·∫°o b√°o c√°o ngay
        </button>
      )}
    </div>
  );
}
```

---

### Fix 6: Realtime Filter Optimization

**File:** `hooks/useFinancialReport.js`

**Changes:**
```javascript
// ‚úÖ Get room IDs for filtering
const [roomIds, setRoomIds] = useState([]);

useEffect(() => {
  const fetchRoomIds = async () => {
    if (!propertyId) {
      setRoomIds([]);
      return;
    }
    
    try {
      const { data: rooms } = await supabase
        .from("rooms")
        .select("id")
        .eq("property_id", propertyId)
        .is("deleted_at", null);
      
      setRoomIds(rooms?.map(r => r.id) || []);
    } catch (error) {
      console.error("Error fetching rooms:", error);
      setRoomIds([]);
    }
  };
  
  fetchRoomIds();
}, [propertyId]);

// In realtime subscription:
.on(
  "postgres_changes",
  {
    event: "INSERT",
    schema: "public",
    table: "bills",
    // ‚úÖ Add filter if propertyId is set
    ...(propertyId && roomIds.length > 0 
      ? { filter: `room_id=in.(${roomIds.join(',')})` }
      : {}
    ),
  },
  (payload) => {
    // ‚úÖ Additional check
    if (propertyId && roomIds.length > 0) {
      if (!roomIds.includes(payload.new.room_id)) {
        return; // Skip if not relevant
      }
    }
    
    console.log("üîî REALTIME: New bill created, refreshing financial report");
    debouncedRefetch();
  }
)
```

---

## Priority 2: UX Improvements

### Fix 7: Add Error Boundary

**File:** `components/ReportErrorBoundary.jsx` (NEW)

```javascript
import React from "react";
import { ExclamationTriangleIcon } from "@heroicons/react/24/outline";

class ReportErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false, error: null };
  }

  static getDerivedStateFromError(error) {
    return { hasError: true, error };
  }

  componentDidCatch(error, errorInfo) {
    console.error("Report Error:", error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      return (
        <div className="bg-red-50 border border-red-200 rounded-xl p-8 text-center">
          <ExclamationTriangleIcon className="h-16 w-16 text-red-500 mx-auto mb-4" />
          <h2 className="text-xl font-bold text-red-900 mb-2">
            ƒê√£ x·∫£y ra l·ªói
          </h2>
          <p className="text-red-700 mb-4">
            {this.state.error?.message || "C√≥ l·ªói x·∫£y ra khi hi·ªÉn th·ªã b√°o c√°o"}
          </p>
          <button
            onClick={() => {
              this.setState({ hasError: false, error: null });
              window.location.reload();
            }}
            className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
          >
            T·∫£i l·∫°i trang
          </button>
        </div>
      );
    }

    return this.props.children;
  }
}

export default ReportErrorBoundary;
```

**Usage in `pages/reports.jsx`:**
```javascript
import ReportErrorBoundary from "../components/ReportErrorBoundary";

// Wrap content:
<ReportErrorBoundary>
  {renderReportContent()}
</ReportErrorBoundary>
```

---

## Testing Checklist

Sau khi apply c√°c fixes, test c√°c scenarios sau:

- [ ] Component unmount kh√¥ng g√¢y memory leak
- [ ] Realtime subscriptions cleanup ƒë√∫ng c√°ch
- [ ] Auto-generate kh√¥ng b·ªã race condition
- [ ] Charts kh√¥ng re-render kh√¥ng c·∫ßn thi·∫øt
- [ ] Loading states hi·ªÉn th·ªã ƒë√∫ng
- [ ] Error states hi·ªÉn th·ªã user-friendly
- [ ] Empty states c√≥ CTA
- [ ] Realtime ch·ªâ trigger khi relevant data changes
- [ ] Performance t·ªët v·ªõi nhi·ªÅu data points
- [ ] Mobile responsive

---

## Notes

- Test k·ªπ realtime subscriptions v·ªõi nhi·ªÅu tabs m·ªü c√πng l√∫c
- Monitor memory usage trong DevTools
- Test v·ªõi slow network ƒë·ªÉ verify loading states
- Test error scenarios (network errors, permission errors)

